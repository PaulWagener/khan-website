{% if context.is_graph_empty %}
<div class="graph-notification">This chart doesn't have any activity to show. Go <a href="/#browse">watch some videos</a> and <a href="/exercisedashboard">do some exercises</a>!</div>
{% endif %}
{% import 'macros/profiles.html' as profile_macros %}
<script>
    var ActivityGraph = {
        graphData: {{ templatetags.jsonify(context, true) }},
        chart: null,
        videoMinutes: {
            type: "column",
            name: "Video Minutes",
            color: "#0080C9",
            data: [],
            defaultPoint: {
                y: 0
            }
        },
        exerciseMinutes: {
            type: "column",
            name: "Exercise Minutes",
            color: "#00C9AF",
            data: [],
            defaultPoint: {
                y: 0
            }
        },
        energyPoints: {
            type: "spline",
            name: "Energy Points",
            yAxis: 1,
            marker: {enabled: false},
            color: "#C9001B",
            data: [],
            defaultPoint: {
                fEnergyPoints: true
            }
        },
        badges: {
            type: 'scatter',
            name: 'Badges',
            showInLegend: false,
            data: [],
            defaultPoint: {
                y: 0,
                enabled: false
            }
        },
        proficientExercises: {
            type: 'scatter',
            name: 'Proficient Exercises',
            showInLegend: false,
            data: [],
            defaultPoint:  {
                y: 0,
                enabled: false
            }
        },
        options: {
            chart: {
                renderTo: 'highchart',
                events: {
                    click: function(e) {
                        if (ActivityGraph.graphData.enableDrillDown) {
                            if (e && e.xAxis && e.xAxis[0]) {
                                ActivityGraph.drillIntoBucket_(Math.round(e.xAxis[0].value || 0));
                            }
                        }
                    }
                }
            },
            plotOptions: {
                column: {
                    stacking: 'normal'
                },
                scatter: {
                    marker: {
                        states: {
                            hover: {
                                fillColor: 'transparent',
                                lineColor: 'transparent'
                            }
                        }
                    }
                }
            },
            yAxis: [
                {
                    title: {
                        text: 'Time Spent (Minutes)',
                        style: {
                            color: '#0080C9'
                        }
                    },
                    labels: {
                        style: {
                            color: '#0080C9'
                        }
                    },
                    min: 0,
                    maxPadding: 0.15,
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },
                {
                    title: {
                        text: 'Energy Points Earned',
                        style: {
                            color: '#C9001B'
                        }
                    },
                    labels: {
                        style: {
                            color: '#C9001B'
                        }
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }],
                    min: 0,
                    opposite: true
                }
            ],
            legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'top',
                floating: true,
                backgroundColor: 'white',
                shadow: true,
                x: 70,
                y: 5,
                itemHoverStyle: {
                    cursor: 'default',
                    color: '#3E576F'
                }
            }
        },
        /**
         * Generate extra Highcharts fields for bars
         * Used for exercise and video minutes
         */
        generateBar_: function(info, tag) {
            if (this.graphData.isGraphEmpty) {
                var y = Math.floor(Math.random() * 20);
                return {y: y};
            }

            if (!info) {
                return {};
            }
            return {
                y: info["minutes"],
                desc: "<strong>" + tag + "</strong> (" + info["timeSpent"] + ")<br/>" +
                    info["htmlSummary"]
            };
        },

        /**
         * Generate extra Highcharts fields for splines
         * Used for energy points
         */
        generateSpline_: function(info) {
            if (this.graphData.isGraphEmpty) {
                var lastIndex = this.videoMinutes.data.length - 1,
                    minutes = this.videoMinutes.data[lastIndex].y + this.exerciseMinutes.data[lastIndex].y,
                    y = minutes * 1000;
                return {y: y};
            }

            if (!info) {
                return {y: 0};
            }

            return {y: info};
        },

        /**
         * Generate extra Highcharts fields for scatter plots
         * Used for badges and proficiencies
         */
        generateScatter_: function(info, tag) {
            if (this.graphData.isGraphEmpty) {
                if (Math.random() > 0.3) {
                    return {};
                }

                var lastIndex = this.videoMinutes.data.length - 1,
                    y = this.videoMinutes.data[lastIndex].y + this.exerciseMinutes.data[lastIndex].y,
                    symbol = (tag === "Achievements" ? 
                            "url(/images/badges/meteorite-small-chart.png)" :
                            "url(/images/node-complete-chart.png)"
                            );
                return {
                    y: y,
                    marker: {
                        symbol: symbol
                    }
                };
            }

            if (!info) {
                return {};
            }
            var symbol = "url(/images/node-complete-chart.png)";

            if (tag === "Achievements") {
                symbol = "url(" + info["badgeUrl"] + ")";
            }

            return {
                    y: info["y"],
                    desc: "<strong>" + tag + "</strong><br/>" + info["htmlSummary"],
                    marker: {
                        symbol: symbol
                    },
                    enabled: true
                };
        },

        generateAllMarks_: function(index, bucket) {
            var x = {x: index},
                extra = {};

            extra = this.generateBar_(this.graphData.dictPlaylistBuckets[bucket], "Videos");
            this.videoMinutes.data.push(_.extend({}, this.videoMinutes.defaultPoint, x, extra));

            extra = this.generateBar_(this.graphData.dictExerciseBuckets[bucket], "Exercises");
            this.exerciseMinutes.data.push(_.extend({}, this.exerciseMinutes.defaultPoint, x, extra));

            extra = this.generateSpline_(this.graphData.dictPointsBuckets[bucket]);
            this.energyPoints.data.push(_.extend({}, this.energyPoints.defaultPoint, x, extra));

            extra = this.generateScatter_(this.graphData.dictBadgeBuckets[bucket], "Achievements");
            this.badges.data.push(_.extend({}, this.badges.defaultPoint, x, extra));

            extra = this.generateScatter_(this.graphData.dictProficiencyBuckets[bucket], "Proficiencies");
            this.proficientExercises.data.push(_.extend({}, this.proficientExercises.defaultPoint, x, extra));
        },

        generateSeries_: function() {
            $.each(this.graphData.bucketList, _.bind(this.generateAllMarks_, this));

            return [
                    this.videoMinutes,
                    this.exerciseMinutes,
                    this.energyPoints,
                    this.badges,
                    this.proficientExercises
            ];
        },

        generateOptions_: function() {
            this.options.xAxis = {
                categories: this.graphData.bucketList,
                labels: {
                    align: 'left',
                    x: -5,
                    y: 10,
                    rotation: 45
                },
                min: 0
            };
            this.options.tooltip = {
                shared: true,
                crosshairs: true,
                formatter: function() {
                    var sTitle = "<b>" + this.x + "</b>";
                    s = "";
                    for (var ix = 0; ix < this.points.length; ix++)
                    {
                        if (this.points[ix].point.desc)
                        {
                            s += "<br/><br/>" + this.points[ix].point.desc;
                        }
                        else if (this.points[ix].point.fEnergyPoints)
                        {
                            sTitle += "<br/>" + this.points[ix].point.y + " energy points";
                        }
                    }
                    return sTitle + s;
                },
                enabled: !this.graphData.isGraphEmpty
            };

            if (this.graphData.graphTitle) {
                this.options.subtitle = {
                    text: this.graphData.graphTitle,
                    x: -10
                };
            }

            if (this.graphData.enableDrillDown) {
                this.options.plotOptions.series = {
                    cursor: 'pointer',
                    events: {
                        legendItemClick: function() { return false; },
                        click: function(e) {
                            if (e && e.point) {
                                ActivityGraph.drillIntoBucket_(e.point.x);
                            }
                        }
                    }
                }
            }
            this.options.series = this.generateSeries_();
        },

        drillIntoBucket_: function(ix) {
            if (ix == null) {
                return;
            }
            var bucket = this.chart.options.xAxis.categories[ix];
            if (bucket) {
                Profile.loadGraph("/profile/graph/activity?student_email=" +
                        this.graphData.studentEmail + "&dt_start=" + bucket);
            }
        },

        render: function() {
            this.generateOptions_();
            this.chart = new Highcharts.Chart(this.options);
        }
    };

    $(function() {
        ActivityGraph.render();
    });
</script>
<div id="highchart-container" class="{% if context.is_graph_empty %}empty-chart{% endif %}">
    <div id="highchart"></div>
</div>
