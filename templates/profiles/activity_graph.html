{% if context.is_graph_empty %}
<div class="graph-notification">This chart doesn't have any activity to show. Go <a href="/#browse">watch some videos</a> and <a href="/exercisedashboard">do some exercises</a>!</div>
{% endif %}
{% import 'macros/profiles.html' as profile_macros %}
<script>
    var graphData = {{ templatetags.jsonify(context, true) }},
        chart;

    function drillIntoBucket(ix) {
        if (ix == null) {
            return;
        }
        var bucket = chart.options.xAxis.categories[ix];
        if (bucket) {
            Profile.loadGraph("/profile/graph/activity?student_email=" +
                    graphData.studentEmail + "&dt_start=" + bucket);
        }
    }

    /**
     * Generate extra Highcharts fields for bars
     * Used for exercise and video minutes
     */
    function generateBar(info, tag) {
        if (!info) {
            return {};
        }
        return {
            y: info["minutes"],
            desc: "<strong>" + tag + "</strong> (" + info["timeSpent"] + ")<br/>" +
                info["htmlSummary"]
        };
    }

    /**
     * Generate extra Highcharts fields for splines
     * Used for energy points
     */
    function generateSpline(info) {
        if (!info) {
            return {y: 0};
        }
        return {y: info};
    }

    /**
     * Generate extra Highcharts fields for scatter plots
     * Used for badges and proficiencies
     */
    function generateScatter(info, tag) {
        if (!info) {
            return {};
        }
        var symbol = "url(/images/node-complete-chart.png)";

        if (tag === "Achievements") {
            symbol = "url(" + info["badgeUrl"] + ")";
        }

        return {
                y: info["y"],
                desc: "<strong>" + tag + "</strong><br/>" + info["htmlSummary"],
                marker: {
                    symbol: symbol
                },
                enabled: true
            };
    }

    function generateSeries() {
        var videoMinutes = {
                type: "column",
                name: "Video Minutes",
                color: "#0080C9",
                data: [],
                defaultPoint: {
                    y: 0
                }
            },
            exerciseMinutes = {
                type: "column",
                name: "Exercise Minutes",
                color: "#00C9AF",
                data: [],
                defaultPoint: {
                    y: 0
                }
            },
            energyPoints = {
                type: "spline",
                name: "Energy Points",
                yAxis: 1,
                marker: {enabled: false},
                color: "#C9001B",
                data: [],
                defaultPoint: {
                    fEnergyPoints: true
                }
            },
            badges = {
                type: 'scatter',
                name: 'Badges',
                showInLegend: false,
                data: [],
                defaultPoint: {
                    y: 0,
                    enabled: false
                }
            },
            proficientExercises = {
                type: 'scatter',
                name: 'Proficient Exercises',
                showInLegend: false,
                data: [],
                defaultPoint:  {
                    y: 0,
                    enabled: false
                }
            };

        $.each(graphData.bucketList, function(index, bucket) {
            var x = {x: index},
                extra = {};

            extra = generateBar(graphData.dictPlaylistBuckets[bucket], "Videos");
            videoMinutes.data.push(_.extend({}, videoMinutes.defaultPoint, x, extra));

            extra = generateBar(graphData.dictExerciseBuckets[bucket], "Exercises");
            exerciseMinutes.data.push(_.extend({}, exerciseMinutes.defaultPoint, x, extra));

            extra = generateSpline(graphData.dictPointsBuckets[bucket]);
            energyPoints.data.push(_.extend({}, energyPoints.defaultPoint, x, extra));

            extra = generateScatter(graphData.dictBadgeBuckets[bucket], "Achievements");
            badges.data.push(_.extend({}, badges.defaultPoint, x, extra));

            extra = generateScatter(graphData.dictProficiencyBuckets[bucket], "Proficiencies");
            proficientExercises.data.push(_.extend({}, proficientExercises.defaultPoint, x, extra));
        });

        return [
                videoMinutes,
                exerciseMinutes,
                energyPoints,
                badges,
                proficientExercises
        ];
    }

    $(function() {
        var options = {
            chart: {
                renderTo: 'highchart',
                events: {
                    click: function(e) {
                        if (graphData.enableDrillDown) {
                            if (e && e.xAxis && e.xAxis[0]) {
                                drillIntoBucket(Math.round(e.xAxis[0].value || 0));
                            }
                        }
                    }
                }
            },
            plotOptions: {
                column: {
                    stacking: 'normal'
                },
                scatter: {
                    marker: {
                        states: {
                            hover: {
                                fillColor: 'transparent',
                                lineColor: 'transparent'
                            }
                        }
                    }
                }
            },
            xAxis: {
                categories: graphData.bucketList,
                labels: {
                    align: 'left',
                    x: -5,
                    y: 10,
                    rotation: 45
                },
                min: 0
            },
            yAxis: [
                {
                    title: {
                        text: 'Time Spent (Minutes)',
                        style: {
                            color: '#0080C9'
                        }
                    },
                    labels: {
                        style: {
                            color: '#0080C9'
                        }
                    },
                    min: 0,
                    maxPadding: 0.15,
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },
                {
                    title: {
                        text: 'Energy Points Earned',
                        style: {
                            color: '#C9001B'
                        }
                    },
                    labels: {
                        style: {
                            color: '#C9001B'
                        }
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }],
                    min: 0,
                    opposite: true
                }
            ],
            tooltip: {
                shared: true,
                crosshairs: true,
                formatter: function() {
                    var sTitle = "<b>" + this.x + "</b>";
                    s = "";
                    for (var ix = 0; ix < this.points.length; ix++)
                    {
                        if (this.points[ix].point.desc)
                        {
                            s += "<br/><br/>" + this.points[ix].point.desc;
                        }
                        else if (this.points[ix].point.fEnergyPoints)
                        {
                            sTitle += "<br/>" + this.points[ix].point.y + " energy points";
                        }
                    }
                    return sTitle + s;
                }
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'top',
                floating: true,
                backgroundColor: 'white',
                shadow: true,
                x: 70,
                y: 5,
                itemHoverStyle: {
                    cursor: 'default',
                    color: '#3E576F'
                }
            }
        };

        if (graphData.graphTitle) {
            options.subtitle = {
                text: graphData.graphTitle,
                x: -10
            };
        }

        if (graphData.enableDrillDown) {
            options.plotOptions.series = {
                cursor: 'pointer',
                events: {
                    legendItemClick: function() { return false; },
                    click: function(e) {
                        if (e && e.point) {
                            drillIntoBucket(e.point.x);
                        }
                    }
                }
            }
        }

        options.series = generateSeries();
        chart = new Highcharts.Chart(options);
    });
</script>
<div id="highchart-container" class="{% if context.is_graph_empty %}empty-chart{% endif %}">
    <div id="highchart"></div>
</div>
