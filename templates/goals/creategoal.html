{% extends "page_template.html" %}

{% import 'macros/exercises.html' as exercise_macros %}

{% block meta_page_title %}Create New Goal | {% endblock meta_page_title %}

{% block pagescript %}
<script>

var GoalCreator = {
    objectives: [],

    init: function() {
        // Fix links on videos
        $('#goal-choose-videos').find('.vl').each(function(index, element) {
            var video_name = $(this).attr('data-id');
            var span = $(this).children('span');

            var image = $(span).css('background-image');
            if (image.indexOf('indicator-complete') == -1)
            {
                var video_title = span.text();
                $(this).attr('href', 'javascript:GoalCreator.onVideoClicked(\'' + video_name + '\', \'' + video_title + '\')');
            } else {
                $(this).attr('href', 'javascript:');
            }
        });

        var form = $('#create-goal');
        form.find('input').mouseup(function() { $(this).removeClass('fieldError'); });

        GoalCreator.updateDescription();
    },
    toggleObjectiveInternal: function(type, id, name) {
        var idx = 1;
        var found_index = -1;

        $.each(GoalCreator.objectives, function(index, objective) {
            if (objective.type == type && objective.id == id) {
                found_index = index;
            }

            if (objective.idx >= idx)
                idx = objective.idx+1;
        });

        if (found_index >= 0) {
            // Remove objective
            var objective = GoalCreator.objectives[found_index];
            objective.element.detach();
            GoalCreator.objectives.splice(found_index, 1);
            return null;
        } else {
            var newElement = $('<div style="float:left;background-color:#e0ffe0;margin:5px;padding:5px"></div>');
            var newObjective = {
                idx: idx,
                element: newElement,
                type: type,
                id: id,
                name: name,
            };

            GoalCreator.objectives.push(newObjective);
            newElement.appendTo('#objective-list');
            return newObjective;
        }
    },
    updateDescription: function() {
        var message = '';
        if (GoalCreator.objectives.length == 0) {
            message = 'This goal currently has no objectives selected. Select exercises or videos to complete below.';
        } else {
            var matchingObjectives;

            message = '<div>To complete this goal, you must:</div><ul>';

            // Exercises
            matchingObjectives = [];
            $.each(GoalCreator.objectives, function(idx, objective) {
                if (objective.type == 'GoalObjectiveExerciseProficiency')
                    matchingObjectives.push(objective);
            });
            if (matchingObjectives.length > 0) {
                message += '<li>Become proficient in exercise';
                if (matchingObjectives.length == 1) {
                    message += ' <b>' + matchingObjectives[0].name + '</b>';
                } else {
                    message += 's ';
                    $.each(matchingObjectives, function(idx, objective) {
                        if (idx == 0)
                            message += '<b>' + objective.name + '</b>';
                        else if (idx < matchingObjectives.length-1)
                            message += ', <b>' + objective.name + '</b>';
                        else
                            message += ' and <b>' + objective.name + '</b>';
                    });
                }
                message += '.</li>';
            }

            // Videos
            matchingObjectives = [];
            $.each(GoalCreator.objectives, function(idx, objective) {
                if (objective.type == 'GoalObjectiveWatchVideo')
                    matchingObjectives.push(objective);
            });
            if (matchingObjectives.length > 0) {
                message += '<li>Watch video';
                if (matchingObjectives.length == 1) {
                    message += ' <b>' + matchingObjectives[0].name + '</b>';
                } else {
                    message += 's ';
                    $.each(matchingObjectives, function(idx, objective) {
                        if (idx == 0)
                            message += '<b>' + objective.name + '</b>';
                        else if (idx < matchingObjectives.length-1)
                            message += ', <b>' + objective.name + '</b>';
                        else
                            message += ' and <b>' + objective.name + '</b>';
                    });
                }
                message += '.</li>';
            }

            message += '</ul>';
        }
        $('#goal-description').html(message);
    },

    showExercises: function() {
        $('#goal-choose-exercises').show();
        $('#goal-choose-videos').hide();
        Drawer.resize();
    },
    updateExercise: function(objective) {
        var html = '<b>Proficiency:</b> ' + objective.name;
        html += ' <a href="javascript:GoalCreator.onExerciseBadgeClicked(\'' + objective.id + '\');"><img src="/images/circled_cross.png"></a>';
        html += '<input type="hidden" name="objective' + objective.idx + '_type" value="GoalObjectiveExerciseProficiency">';
        html += '<input type="hidden" name="objective' + objective.idx + '_exercise" value="' + objective.id + '">';
        objective.element.html(html);
    },
    onExerciseClicked: function(node, evt) {
       if (node.status == 'Proficient')
           return; // Cannot select exercises the user is proficient in

        var newObjective = GoalCreator.toggleObjectiveInternal('GoalObjectiveExerciseProficiency', node.id, node.name);
        if (newObjective) {
            GoalCreator.updateExercise(newObjective);
        }

        GoalCreator.updateExerciseCount();
        GoalCreator.updateDescription();
    },
    onExerciseBadgeClicked: function(id) {
        this.onExerciseClicked(KnowledgeMap.dictNodes[id], null);
    },
    updateExerciseCount: function() {
        var count = 0;

        $.each(GoalCreator.objectives, function(index, objective) {
            if (objective.type == 'GoalObjectiveExerciseProficiency')
                count++;
        });

        $('#goal-exercise-count').html(count);

        $.each(KnowledgeMap.getBadgeElements(), function(index, badge) {
            var exercise = badge.dataID;
            var found = false;

            $.each(GoalCreator.objectives, function(index2, objective) {
                if (objective.type == 'GoalObjectiveExerciseProficiency' && objective.id == exercise)
                {
                    found = true;
                }
            });

            var goalIcon = $(badge.badgeElement).children('.exercise-goal-icon');
            if (found)
            {
                if (goalIcon.length == 0)
                    $('<div class="exercise-goal-icon"><img src="/images/flag.png"></div>').appendTo(badge.badgeElement);
            }
            else
            {
                goalIcon.detach();
            }
        });
    },

    updateVideo: function(objective) {
        var html = '<b>Video:</b> ' + objective.name;
        html += ' <a href="javascript:GoalCreator.onVideoClicked(\'' + objective.id + '\', null);"><img src="/images/circled_cross.png"></a>';
        html += '<input type="hidden" name="objective' + objective.idx + '_type" value="GoalObjectiveWatchVideo">';
        html += '<input type="hidden" name="objective' + objective.idx + '_video" value="' + objective.id + '">';
        objective.element.html(html);
    },
    onVideoClicked: function(id, title) {
        var newObjective = GoalCreator.toggleObjectiveInternal('GoalObjectiveWatchVideo', id, title);
        if (newObjective) {
            GoalCreator.updateVideo(newObjective);
        }

        GoalCreator.updateVideoCount();
        GoalCreator.updateDescription();
    },
    showVideos: function() {
        $('#goal-choose-exercises').hide();
        $('#goal-choose-videos').show();
        Drawer.resize();
    },
    updateVideoCount: function() {
        var count = 0;

        $.each(GoalCreator.objectives, function(index, objective) {
            if (objective.type == 'GoalObjectiveWatchVideo')
                count++;
        });

        $('#goal-video-count').html(count);

        $('#library-content-main').find('.vl').each(function(index, element) {
            var video_name = $(element).attr('data-id');
            var found = false;

            $.each(GoalCreator.objectives, function(index2, objective) {
                if (objective.type == 'GoalObjectiveWatchVideo' && objective.id == video_name)
                {
                    found = true;
                }
            });

            var goalIcon = $(element).children('.video-goal-icon');
            if (found)
            {
                if (goalIcon.length == 0)
                    $('<span class="video-goal-icon"><img src="/images/flag.png"></span>').insertBefore($(element).children('span')[0]);
            }
            else
            {
                goalIcon.detach();
            }
        });
    },

    validate: function(form) {
        var error = '';

        var titleField = form.find('input[name="title"]');
        if (titleField.val() == '')
        {
            error = 'You must give your goal a name.';
            titleField.addClass('fieldError');
        } else {
            titleField.removeClass('fieldError');
        }

        if (GoalCreator.objectives.length == 0)
        {
            error = 'You must select at least one objective to complete.';
        }

        if (error != '') {
            $('#goal-commit-response').html(error);
            return false;
        }
        return true;
    },
    submit: function() {
        var form = $('#create-goal');

        if (!GoalCreator.validate(form))
            return;

        $.ajax({
            url: "/api/v1/user/goals/create",
            type: 'POST',
            dataType: 'text',
            data: $(form).serialize(),
            success: function(json) {
                document.location = '/profile?k#/?graph_url=/api/v1/user/goals'; // Take the user to the goals list in their profile
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $('#goal-commit-response').html('Goal creation failed: ' + jqXHR.responseText);
            },
        });
        return false;
    },
};

$(function() {
    GoalCreator.init();
    Drawer.init();
    GoalCreator.showExercises();
    KnowledgeMap.initFilter();
    KnowledgeMap.setNodeClickHandler(GoalCreator.onExerciseClicked);
});

</script>
{% endblock pagescript %}

{% block pagecontent %}
<div><h1>Create a new goal:<h1></div>
<form id="create-goal" action="javascript:">
  <div>
    <span id="goal-commit-response" style="color:#f00"></span>
    <h2>Goal title: <input type="text" name="title"></input> <a href="javascript:GoalCreator.submit();" style="float: right;"><span class="simple-button action-gradient">Create New Goal<span></a></h2>
  </div>
  <div>
    <h2>Objectives:</h2>
    <div id="objective-list"></div>
    <div id="goal-description" style="clear: left;"></div>
  </div>
</form>

<div style="float: left; margin-left: 10px;"><a href="javascript:GoalCreator.showExercises();">Choose exercises</a> (<span id="goal-exercise-count">0</span> selected)</div>
<div style="float: left; margin-left: 10px;"><a href="javascript:GoalCreator.showVideos();">Choose videos</a> (<span>0</span> selected)</div>

<div id="container" style="clear: left" class="dashboard{% if not logged_in %} unregistered{% endif %}">
  <div id="goal-choose-exercises" style="display: none;">
    {{ exercise_macros.exercise_legend() }}
    {{ exercise_macros.exercise_dashboard(review_graph_dicts, suggested_graph_dicts, null, graph_dicts, 'creategoal') }}

    <div id="dashboard-map">
        {{ exercise_macros.knowledgemap(graph_dicts, map_coords) }}
    </div>
  </div>

  <div id="goal-choose-videos" style="display: none;">
    <div class="dashboard-header">
      <div class="dashboard-nav">
        {{ templatetags.playlist_browser("browse") }}
      </div>
      <div class="dashboard-title"><img src="/images/video.png" id="dashboard-icon" width=22 height=22 /> Videos </div>
    </div>
    <div class="dashboard-content">
{{ library_content }}
    </div>
  </div>
</div>

{% endblock pagecontent %}

